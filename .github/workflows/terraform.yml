
  on:
    push:
      branches: [ "main" ]
    pull_request:
  
  permissions:
    contents: read
  
  jobs:
    terraform:
      name: 'Terraform'
      runs-on: ubuntu-latest
      environment: production
  
      defaults:
        run:
          shell: bash
  
      steps:
        - name: Checkout
          uses: actions/checkout@v3
  
        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v1
  
        - name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v1
          with:
            token_format: 'access_token' 
            workload_identity_provider: 'projects/425063330482/locations/global/workloadIdentityPools/github1/attribute.repository/Salvador-Menjivar-S/terraform'
            service_account: 'github-actions@smenjivar-dev.iam.gserviceaccount.com'
  
        - name: Terraform Init
          run: terraform init
  
        - name: Terraform Format
          run: terraform fmt -check
  
        - name: Terraform Plan
          run: terraform plan -input=false
  
        - name: Terraform Apply
          if: github.ref == 'refs/heads/main' && github.event_name == 'push'
          run: terraform apply -auto-approve -input=false
          env: 
            GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }} 
            TF_STATE_BUCKET_NAME: ${{ secrets.TF_STATE_BUCKET_NAME }}
  
  